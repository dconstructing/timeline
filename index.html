<!DOCTYPE HTML>
<html>
	<head>
		<title>Timeline basic demo</title>

		<script src="https://unpkg.com/moment/moment.js"></script>
		<script src="https://unpkg.com/timeline-plus/dist/timeline.js"></script>
		<script src="https://unpkg.com/html2canvas/dist/html2canvas.js"></script>

		<script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
		<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
		<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
		<script src="https://unpkg.com/react-datetime/dist/react-datetime.js"></script>

		<link href="https://unpkg.com/timeline-plus/dist/timeline.css" rel="stylesheet" type="text/css" />
		<link href="https://unpkg.com/react-datetime/css/react-datetime.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
		<h1>Timeline Generator</h1>
		<p>Enter your event details to automatically build a timeline. Red line represents current time in UTC.</p>

		<div id="react"></div>

		<script type="text/babel">
			function generateChartItems(events) {
				return events.map((event, i) => {
					return {
						start: event.datetime,
						content: event.note
					}
				});
			}

			class Chart extends React.Component {
				constructor(props) {
					super(props);
				}

				componentDidMount() {
					var container = document.getElementById('mytimeline');
					const items = generateChartItems(this.props.events);
					const options = {
						moment: function(date) {
							return timeline.moment(date).utc();
						}
					};
					this.timeline = new timeline.Timeline(container, items, options);
				}

				shouldComponentUpdate(nextProps, nextState) {
					console.log('checking update')
					const items = generateChartItems(nextProps.events);
					this.timeline.setItems(items)
					this.timeline.redraw();
					this.timeline.fit(items);
					return false;
				}

				render() {
					return <div id="mytimeline" />
				}
			}

			class TimelineEvent extends React.Component {
				constructor(props) {
					super(props);

					this.datetimeChanged = this.datetimeChanged.bind(this);
					this.noteChanged = this.noteChanged.bind(this); 
				}

				datetimeChanged(datetime) {
					const updatedEvent = {
						datetime: datetime,
						note: this.props.event.note
					}
					this.props.onUpdate(this.props.sort, updatedEvent)
				}

				noteChanged(event) {
					const updatedEvent = {
						datetime: this.props.event.datetime,
						note: event.target.value
					}
					this.props.onUpdate(this.props.sort, updatedEvent)
				}

				render() {
					return (
						<div>
							<form>
								<Datetime utc inputProps={{ placeholder: 'Datetime'}} value={this.props.event.datetime} onChange={this.datetimeChanged} />
								<input placeholder="Note" value={this.props.event.note} onChange={this.noteChanged} />
							</form>
						</div>
					)
				}
			}

			function blankTimelineEvent() {
				return {
					datetime: '',
					note: ''
				}
			}

			class TimelineEvents extends React.Component {
				constructor(props) {
					super(props);
					this.state = {
						events: [],
						newEvent: blankTimelineEvent()
					};

					this.datetimeChanged = this.datetimeChanged.bind(this);
					this.noteChanged = this.noteChanged.bind(this); 
					this.handleSubmit = this.handleSubmit.bind(this);
					this.handleUpdate = this.handleUpdate.bind(this);
					this.handleExport = this.handleExport.bind(this);
				}

				datetimeChanged(datetime) {
					const newEvent = this.state.newEvent;
					newEvent.datetime = datetime;
					this.setState({newEvent: newEvent});
				}

				noteChanged(event) {
					const newEvent = this.state.newEvent;
					newEvent.note = event.target.value;
					this.setState({newEvent: newEvent});
				}

				handleSubmit(event) {
					console.log(this.state)
					const eventSet = this.state.events;
					eventSet.push(this.state.newEvent);
					this.setState({events: eventSet, newEvent: blankTimelineEvent()});
					event.preventDefault();
				}

				handleUpdate(sort, timelineEvent) {
					console.log(this.state);
					console.log(sort, timelineEvent);
					const eventSet = this.state.events;
					eventSet.splice(sort, 1, timelineEvent);
					console.log(eventSet);
					this.setState({events: eventSet});
				}

				handleExport(event) {
					const container = document.getElementById('mytimeline');
					html2canvas(container).then(function(canvas) {
						var link = document.createElement('a');
						link.download = 'timeline.png';
						canvas.toBlob(function(blob) {
							link.href = URL.createObjectURL(blob);
							link.click();
						},'image/png');
					});
				}

				render() {
					const events = this.state.events.map((event, i) => <TimelineEvent key={i} sort={i} event={event} onUpdate={this.handleUpdate} />)
					return (
						<div>
							<Chart events={this.state.events} />
							<button onClick={this.handleExport}>Save as PNG</button>
							<h2>Events</h2>
							<p>Expects times in UTC</p>
							{events}
							<div>
								<form onSubmit={this.handleSubmit}>
									<Datetime utc inputProps={{ placeholder: 'Datetime'}} value={this.state.newEvent.datetime} onChange={this.datetimeChanged} />
									<input placeholder="Note" value={this.state.newEvent.note} onChange={this.noteChanged} />
									<button type="submit">Add</button>
								</form>
							</div>
						</div>
					)
				}
			}
			
			ReactDOM.render(
				<TimelineEvents />,
				document.getElementById('react')
			);
		</script>
	</body>
</html>